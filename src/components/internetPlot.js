import React, { useEffect, useRef } from 'react';
import * as d3 from 'd3';

const InternetAccessViz = ({ data, width = 300, height = 170, selectedInternetAccess, updateInternetAccess }) => {
  const svgRef = useRef(null);

  useEffect(() => {
    if (!data || !data.length) return;

    const internetAccessCounts = d3.rollup(
      data,
      v => v.length,
      d => d.Internet_Access
    );

    const totalCount = d3.sum([...internetAccessCounts.values()]);
    
    const yesCount = internetAccessCounts.get('Yes') || 0;
    const noCount = internetAccessCounts.get('No') || 0;
    
    const yesPercentage = (yesCount / totalCount) * 100;
    const noPercentage = (noCount / totalCount) * 100;

    d3.select(svgRef.current).selectAll('*').remove();

    const svg = d3.select(svgRef.current)
      .attr('width', width)
      .attr('height', height)
      .attr('viewBox', '0 0 400 200')
      .attr('preserveAspectRatio', 'xMidYMid meet')
      .style('overflow', 'visible');

    const yesGradient = svg.append('defs')
      .append('linearGradient')
      .attr('id', 'yes-gradient')
      .attr('x1', '0%')
      .attr('x2', '0%')
      .attr('y1', '0%')
      .attr('y2', '100%');

    yesGradient.append('stop')
      .attr('offset', `0%`)
      .attr('stop-color', '#ccc');

    yesGradient.append('stop')
      .attr('offset', `${100-yesPercentage}%`)
      .attr('stop-color', '#ccc');

    yesGradient.append('stop')
      .attr('offset', `${100-yesPercentage}%`)
      .attr('stop-color','#4682B4');

    yesGradient.append('stop')
      .attr('offset', '100%')
      .attr('stop-color','#4682B4');

    const noGradient = svg.append('defs')
      .append('linearGradient')
      .attr('id', 'no-gradient')
      .attr('x1', '0%')
      .attr('x2', '0%')
      .attr('y1', '0%')
      .attr('y2', '100%');

    noGradient.append('stop')
      .attr('offset', `0%`)
      .attr('stop-color', '#ccc');

    noGradient.append('stop')
      .attr('offset', `${100-noPercentage}%`)
      .attr('stop-color', '#ccc');

    noGradient.append('stop')
      .attr('offset', `${100-noPercentage}%`)
      .attr('stop-color', '#FF69B4');

    noGradient.append('stop')
      .attr('offset', '100%')
      .attr('stop-color','#FF69B4');

    const yesGroup = svg.append('g')
      .attr('transform', `translate(80, 30)`)
      .style('cursor', 'pointer')
      .on('click', () => {
        if (selectedInternetAccess.includes("Yes")) {
      updateInternetAccess(selectedInternetAccess.filter((g) => g !== "Yes"));
    } else {
      updateInternetAccess([...selectedInternetAccess, "Yes"]);
    }
      });

    const noGroup = svg.append('g')
      .attr('transform', `translate(240, 20)`)
      .style('cursor', 'pointer')
      .on('click', () => {
        if (selectedInternetAccess.includes("No")) {
      updateInternetAccess(selectedInternetAccess.filter((g) => g !== "No"));
    } else {
      updateInternetAccess([...selectedInternetAccess, "No"]);
    }
      });

    const yesSvg = yesGroup.append('g')
      .attr('transform', 'scale(0.95)')
      .style('fill', 'url(#yes-gradient)')
      .style('stroke', 'black')
      .style('stroke-width', '0.5');

    yesSvg.html(`
      <path d="m5.0781 50c0-24.793 20.129-44.922 44.922-44.922 24.789 0 44.922 20.129 44.922 44.922 0 24.789-20.129 44.922-44.922 44.922s-44.922-20.129-44.922-44.922zm35.461-41.512c-10.379 2.3555-19.305 8.5-25.281 16.906h14.125c2.5664-7.1992 6.2344-12.914 10.516-16.414 0.21484-0.16797 0.42969-0.33594 0.64062-0.48828zm-26.824 19.242c-3.7891 6.1758-6.0664 13.375-6.2656 21.094h11.723c0.30469-8.2695 3.8828-15.727 9.4766-21.094zm78.852 21.094c-0.21484-7.7188-2.4766-14.918-6.2656-21.094h-14.934c5.5938 5.3672 9.1719 12.824 9.4766 21.094zm-7.8242-23.43c-5.9609-8.4062-14.902-14.551-25.266-16.906 0.21484 0.15234 0.42969 0.32031 0.625 0.48828 4.2969 3.5 7.9609 9.2188 10.531 16.414h14.109zm-25.266 66.121c10.363-2.3555 19.305-8.5 25.266-16.906h-14.109c-2.5703 7.1992-6.2344 12.914-10.531 16.414-0.19922 0.16797-0.41406 0.33594-0.625 0.48828zm26.824-19.242c3.7891-6.1758 6.0547-13.375 6.2656-21.094h-11.723c-0.30469 8.2695-3.8828 15.727-9.4766 21.094zm-78.852-21.098c0.19922 7.7188 2.4766 14.918 6.2656 21.094h14.934c-5.5938-5.3633-9.1719-12.824-9.4766-21.094zm7.8125 23.43c5.9766 8.4062 14.902 14.551 25.281 16.906-0.21484-0.15234-0.42969-0.32031-0.64062-0.48828-4.2812-3.5-7.9492-9.2188-10.516-16.414h-14.125zm33.578-67.125c-3.4219 0.35156-6.6172 2.1992-9.4453 5.1641-2.8906 3.043-5.3945 7.2305-7.3203 12.242 4.7539-3.4062 10.531-5.4844 16.766-5.7305zm1.1641 14c-15.727 0-28.508 12.777-28.508 28.523 0 15.742 12.777 28.52 28.508 28.52 15.742 0 28.52-12.777 28.52-28.52 0-15.742-12.777-28.523-28.52-28.523zm1.1758-2.3242c6.2344 0.24609 12.016 2.3242 16.766 5.7305-1.9414-5.0117-4.4336-9.1992-7.3359-12.242-2.8125-2.9648-6.0078-4.8125-9.4297-5.1641zm0 73.367c3.4219-0.35156 6.6172-2.1992 9.4297-5.1641 2.9023-3.043 5.3945-7.2305 7.3359-12.242-4.7539 3.4062-10.531 5.4844-16.766 5.7305zm-2.3398-11.676c-6.2344-0.24609-12.012-2.3242-16.766-5.7305 1.9258 5.0117 4.4336 9.1992 7.3203 12.242 2.8281 2.9648 6.0234 4.8125 9.4453 5.1641zm1.1641-55.453c13.586 0 24.609 11.02 24.609 24.609 0 13.586-11.02 24.609-24.609 24.609-13.574 0-24.609-11.02-24.609-24.609s11.035-24.609 24.609-24.609zm0 2.3398c-12.289 0-22.254 9.9805-22.254 22.27 0 12.289 9.9648 22.27 22.254 22.27 12.289 0 22.27-9.9805 22.27-22.27 0-12.289-9.9805-22.27-22.27-22.27zm9.6758 25.098c0.45703 0.46094 0.45703 1.207 0 1.6523-0.46094 0.45703-1.207 0.45703-1.6641 0-4.418-4.418-11.586-4.418-16.02 0-0.46094 0.45703-1.1914 0.45703-1.6523 0-0.45703-0.44531-0.45703-1.1914 0-1.6523 5.3359-5.3359 14-5.3359 19.336 0zm4.418-4.418c0.45703 0.46094 0.45703 1.1914 0 1.6523-0.46094 0.45703-1.207 0.45703-1.6523 0-6.8633-6.8633-18.004-6.8633-24.867 0-0.46094 0.45703-1.1914 0.45703-1.6523 0-0.45703-0.46094-0.45703-1.1914 0-1.6523 7.7656-7.7812 20.391-7.7812 28.172 0zm-14.094 6.6641c2.3672 0 4.2969 1.9258 4.2969 4.2969 0 2.3828-1.9258 4.2969-4.2969 4.2969-2.3672 0-4.2969-1.9102-4.2969-4.2969 0-2.3672 1.9258-4.2969 4.2969-4.2969zm0 2.3555c-1.0703 0-1.9414 0.87109-1.9414 1.9414 0 1.0859 0.87109 1.957 1.9414 1.957 1.0859 0 1.957-0.87109 1.957-1.957 0-1.0703-0.87109-1.9414-1.957-1.9414zm18.508-13.438c0.45703 0.46094 0.45703 1.1914 0 1.6523-0.46094 0.45703-1.1914 0.45703-1.6523 0-9.3086-9.293-24.41-9.293-33.703 0-0.46094 0.45703-1.207 0.45703-1.6523 0-0.45703-0.46094-0.45703-1.1914 0-1.6523 10.211-10.227 26.793-10.227 37.004 0z"/>
    `);

    const noSvg = noGroup.append('g')
      .attr('transform', 'scale(1.1)')
      .style('fill', 'url(#no-gradient)')
      .style('stroke', 'black')
      .style('stroke-width', '0.5');

    noSvg.html(`
      <path d="m90.109 15.891h-80.219c-1.2969 0-2.3438 1.0469-2.3438 2.3438v63.547c0 1.2969 1.0469 2.3438 2.3438 2.3438h80.203c1.2969 0 2.3438-1.0469 2.3438-2.3438v-63.547c0.015625-1.2969-1.0469-2.3438-2.3281-2.3438zm0.78125 65.875c0 0.4375-0.34375 0.78125-0.78125 0.78125h-80.219c-0.4375 0-0.78125-0.34375-0.78125-0.78125v-51.812h81.766v51.812zm0-53.375h-81.781v-10.156c0-0.4375 0.34375-0.78125 0.78125-0.78125h80.203c0.4375 0 0.78125 0.34375 0.78125 0.78125v10.156z"/>
      <path d="m14.578 20.047c-1.5781 0-2.8594 1.2812-2.8594 2.8594s1.2812 2.8594 2.8594 2.8594 2.8594-1.2812 2.8594-2.8594c0.015625-1.5625-1.2812-2.8594-2.8594-2.8594zm0 4.1719c-0.71875 0-1.2969-0.57812-1.2969-1.2969s0.57812-1.2969 1.2969-1.2969 1.2969 0.57812 1.2969 1.2969-0.57812 1.2969-1.2969 1.2969z"/>
      <path d="m22.922 20.047c-1.5781 0-2.8594 1.2812-2.8594 2.8594s1.2812 2.8594 2.8594 2.8594 2.8594-1.2812 2.8594-2.8594c0-1.5625-1.2812-2.8594-2.8594-2.8594zm0 4.1719c-0.71875 0-1.2969-0.57812-1.2969-1.2969s0.57812-1.2969 1.2969-1.2969 1.2969 0.57812 1.2969 1.2969-0.57812 1.2969-1.2969 1.2969z"/>
      <path d="m31.25 20.047c-1.5781 0-2.8594 1.2812-2.8594 2.8594s1.2812 2.8594 2.8594 2.8594 2.8594-1.2812 2.8594-2.8594c0-1.5625-1.2812-2.8594-2.8594-2.8594zm0 4.1719c-0.71875 0-1.2969-0.57812-1.2969-1.2969s0.57812-1.2969 1.2969-1.2969 1.2969 0.57812 1.2969 1.2969-0.57812 1.2969-1.2969 1.2969z"/>
      <path d="m87.5 20.047h-33.328c-0.4375 0-0.78125 0.34375-0.78125 0.78125v4.1719c0 0.4375 0.34375 0.78125 0.78125 0.78125h33.328c0.4375 0 0.78125-0.34375 0.78125-0.78125v-4.1719c0-0.42188-0.34375-0.78125-0.78125-0.78125zm-0.78125 4.1719h-31.766v-2.6094h31.766z"/>
      <path d="m32.953 55.531c0.14062 0.14062 0.34375 0.23438 0.54688 0.23438s0.40625-0.078125 0.54688-0.23438c4.6094-4.6094 10.953-6.9531 17.469-6.5 1.5781 2.8906 4.6562 4.8594 8.1719 4.8594 1.2344 0 2.4062-0.25 3.4844-0.6875 0.95312 0.67188 1.875 1.4375 2.7656 2.3281 0.14062 0.14062 0.34375 0.23438 0.54688 0.23438s0.40625-0.078125 0.54688-0.23438l3.2344-3.2344c0.3125-0.3125 0.3125-0.79688 0-1.1094-0.78125-0.78125-1.5938-1.4844-2.4375-2.1562 0.71875-1.3281 1.1406-2.8438 1.1406-4.4531 0-5.125-4.1719-9.2969-9.2969-9.2969-4.5312 0-8.3125 3.2656-9.1406 7.5625-7.7812-0.14062-15.359 2.8594-20.844 8.3438-0.3125 0.3125-0.3125 0.79688 0 1.1094zm35.672-3.7812-2.125 2.125c-0.57812-0.54688-1.1719-1.0312-1.7656-1.4844 0.85938-0.54688 1.6094-1.25 2.25-2.0469 0.54688 0.45312 1.1094 0.90625 1.6406 1.4062zm-8.9375-14.906c4.2656 0 7.7344 3.4688 7.7344 7.7344s-3.4688 7.7344-7.7344 7.7344-7.7344-3.4688-7.7344-7.7344 3.4688-7.7344 7.7344-7.7344zm-9.2969 7.5625c0 0.0625-0.015625 0.125-0.015625 0.17188 0 1 0.15625 1.9531 0.45312 2.8594-6.4219-0.23438-12.641 2.0469-17.328 6.4375l-2.125-2.125c5.1094-4.8125 11.969-7.4375 19.016-7.3438z"/>
      <path d="m50 53.047c-4.9219 0-9.5625 1.9219-13.047 5.4062-0.3125 0.3125-0.3125 0.79688 0 1.1094l3.2344 3.2344c0.3125 0.3125 0.79688 0.3125 1.1094 0 2.3281-2.3281 5.4219-3.6094 8.7031-3.6094s6.375 1.2812 8.7031 3.6094c0.15625 0.15625 0.35938 0.23438 0.54688 0.23438s0.40625-0.078125 0.54688-0.23438l3.2344-3.2344c0.3125-0.3125 0.3125-0.79688 0-1.1094-3.4688-3.5-8.1094-5.4062-13.031-5.4062zm9.2344 8.0938c-2.5469-2.2812-5.7969-3.5312-9.2344-3.5312s-6.6875 1.25-9.2344 3.5312l-2.125-2.125c3.1094-2.8438 7.125-4.4062 11.375-4.4062s8.25 1.5625 11.375 4.4062z"/>
      <path d="m50 62.438c-2.9375 0-5.3281 2.3906-5.3281 5.3281s2.3906 5.3281 5.3281 5.3281 5.3281-2.3906 5.3281-5.3281-2.3906-5.3281-5.3281-5.3281zm0 9.0781c-2.0781 0-3.7656-1.6875-3.7656-3.7656s1.6875-3.7656 3.7656-3.7656 3.7656 1.6875 3.7656 3.7656-1.6875 3.7656-3.7656 3.7656z"/>
      <path d="m55.969 48.297c0.15625 0.15625 0.35938 0.23438 0.54688 0.23438s0.40625-0.078125 0.54688-0.23438l2.6094-2.6094 2.6094 2.6094c0.15625 0.15625 0.35938 0.23438 0.54688 0.23438s0.40625-0.078125 0.54688-0.23438c0.3125-0.3125 0.3125-0.79688 0-1.1094l-2.6094-2.6094 2.6094-2.6094c0.3125-0.3125 0.3125-0.79688 0-1.1094s-0.79688-0.3125-1.1094 0l-2.6094 2.6094-2.6094-2.6094c-0.3125-0.3125-0.79688-0.3125-1.1094 0s-0.3125 0.79688 0 1.1094l2.6094 2.6094-2.6094 2.6094c-0.26562 0.3125-0.26562 0.8125 0.03125 1.1094z"/>
    `);

    yesGroup.append('text')
      .attr('x', 50)
      .attr('y', 120)
      .attr('text-anchor', 'middle')
      .style('font-size', '16px')
      .style('font-weight', 'bold')
      .text(`${Math.round(yesPercentage)}%`);

    noGroup.append('text')
      .attr('x', 50)
      .attr('y', 127)
      .attr('text-anchor', 'middle')
      .style('font-size', '16px')
      .style('font-weight', 'bold')
      .text(`${Math.round(noPercentage)}%`);

    yesGroup.append('text')
      .attr('x', 47)
      .attr('y', 140)
      .attr('text-anchor', 'middle')
      .style('font-size', '16px')
      .text('Yes');

    noGroup.append('text')
      .attr('x', 47)
      .attr('y', 147)
      .attr('text-anchor', 'middle')
      .style('font-size', '16px')
      .text('No');

    svg.append('text')
      .attr('x', 200)
      .attr('y', 15)
      .attr('text-anchor', 'middle')
      .style('font-size', '18px')
      .style('font-weight', 'bold')
      .text('Internet Access');

    yesGroup.on('mouseover', function() {
      d3.select(this).style('opacity', 0.8);
    }).on('mouseout', function() {
      d3.select(this).style('opacity', 1);
    });

    noGroup.on('mouseover', function() {
      d3.select(this).style('opacity', 0.8);
    }).on('mouseout', function() {
      d3.select(this).style('opacity', 1);
    });

  }, [data, width, height, selectedInternetAccess, updateInternetAccess]);

  return <svg ref={svgRef}></svg>;
};

export default InternetAccessViz;
